<div class="row">
    <div class="col-sm-12">
        <div class="card border-0 shadow-none bg-transparent">

            <!-- HEADER: TITLE & CUSTOMER SEARCH -->
            <div class="card shadow-sm border-0 mb-4 rounded-3 animate__animated animate__fadeInDown">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0 fw-bold text-dark text-uppercase letter-spacing-1">
                            <i class="feather icon-file-text text-primary me-2"></i>
                            {{ isEditMode ? 'Edit Deposit #' + editId : 'New Deposit Entry' }}
                        </h5>
                        <button class="btn btn-primary btn-sm rounded-pill px-3" (click)="openNewCustomerModal()">
                            <i class="feather icon-user-plus me-1"></i> New Customer
                        </button>
                    </div>

                    <!-- Customer Search Bar -->
                    <div class="position-relative">
                        <div class="input-group input-group-lg shadow-sm rounded-pill overflow-hidden bg-white border">
                            <span class="input-group-text border-0 bg-transparent ps-4">
                                <i class="feather icon-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-0 bg-transparent ps-2"
                                placeholder="Search Customer by Name, Mobile or ID..." [(ngModel)]="searchTerm"
                                name="searchBox" (input)="searchCustomers()" [disabled]="isEditMode" autocomplete="off">
                        </div>

                        <!-- Dropdown Results -->
                        <div class="dropdown-menu show w-100 shadow-lg border-0 mt-2 rounded-3" *ngIf="showResults"
                            style="position: absolute; z-index: 1050; max-height: 350px; overflow-y: auto;">
                            <a class="dropdown-item py-3 border-bottom d-flex align-items-center"
                                *ngFor="let result of searchResults" (click)="selectCustomer(result)"
                                href="javascript:void(0)">
                                <div class="bg-light rounded-circle p-2 me-3 text-center"
                                    style="width: 40px; height: 40px;">
                                    <i class="feather icon-user text-secondary"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="mb-0 text-dark fw-bold">{{ result.customerName }}</h6>
                                    <small class="text-muted">
                                        <i class="feather icon-phone me-1"></i>{{ result.mobileNumber }}
                                        <span class="mx-2">â€¢</span>
                                        {{ result.city }}
                                    </small>
                                </div>
                                <span class="badge bg-light text-dark border">ID: {{ result.id }}</span>
                            </a>
                        </div>
                    </div>

                    <!-- Selected Customer Profile Card -->
                    <div class="mt-4 animate__animated animate__fadeIn" *ngIf="selectedCustomer">
                        <div
                            class="bg-primary-light border border-primary-light rounded-3 p-3 position-relative overflow-hidden">
                            <div class="d-flex align-items-center position-relative" style="z-index: 1;">
                                <div class="bg-white p-3 rounded-circle shadow-sm text-primary me-3">
                                    <i class="feather icon-user fs-4"></i>
                                </div>
                                <div>
                                    <h5 class="mb-1 text-primary fw-bold">{{ selectedCustomer.customerName }}</h5>
                                    <div class="d-flex align-items-center text-secondary small fw-bold">
                                        <span class="me-3"><i class="feather icon-phone me-1"></i> {{
                                            selectedCustomer.mobileNumber }}</span>
                                        <span class="me-3"><i class="feather icon-map-pin me-1"></i> {{
                                            selectedCustomer.city }}</span>
                                        <span class="badge bg-primary rounded-pill">ID: {{ selectedCustomer.id }}</span>
                                    </div>
                                </div>
                            </div>
                            <!-- Background Decoration -->
                            <i class="feather icon-users position-absolute text-primary opacity-10"
                                style="right: -20px; bottom: -20px; font-size: 8rem; opacity: 0.05;"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TRANSACTION CONTROL RIBBON (Token, Date, Interest) -->
            <div class="row g-3 mb-4">
                <!-- Token Number -->
                <div class="col-md-5">
                    <div class="card shadow-sm border-0 h-100 rounded-3">
                        <div class="card-body py-3 px-4 d-flex flex-column justify-content-center">
                            <label class="text-muted small fw-bold text-uppercase mb-2">Token Number <span
                                    class="text-danger">*</span></label>
                            <div class="d-flex align-items-center">
                                <div class="flex-grow-1 position-relative">
                                    <div class="input-group shadow-sm rounded overflow-hidden"
                                        [class.border]="tokenStatus === 'invalid'"
                                        [class.border-danger]="tokenStatus === 'invalid'">
                                        <span class="input-group-text bg-white border-0 ps-3">
                                            <i class="feather icon-tag text-dark"></i>
                                        </span>
                                        <input type="number" class="form-control border-0 fw-bold fs-5 text-dark"
                                            [(ngModel)]="deposit.tokenNo" name="tokenNo" placeholder="---" min="1"
                                            (input)="onTokenInput()" autocomplete="off">
                                        <button class="btn btn-dark fw-bold px-3" (click)="generateToken()">
                                            <i class="feather icon-zap text-warning me-1"></i> Auto
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <!-- Status Line -->
                            <div class="d-flex align-items-center mt-2" style="min-height: 20px;">
                                <div *ngIf="tokenStatus === 'loading'" class="text-primary small fw-bold"><i
                                        class="feather icon-loader fa-spin me-1"></i> Checking...</div>
                                <div *ngIf="tokenStatus === 'valid'" class="text-success small fw-bold"><i
                                        class="feather icon-check-circle me-1"></i> Available</div>
                                <div *ngIf="tokenStatus === 'invalid'" class="text-danger small fw-bold"><i
                                        class="feather icon-alert-triangle me-1"></i> {{ tokenErrorMessage }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Date -->
                <div class="col-md-4">
                    <div class="card shadow-sm border-0 h-100 rounded-3">
                        <div class="card-body py-3 px-4 d-flex flex-column justify-content-center">
                            <label class="text-muted small fw-bold text-uppercase mb-2">Deposit Date <span
                                    class="text-danger">*</span></label>
                            <div class="input-group shadow-sm rounded">
                                <span class="input-group-text bg-light border-0"><i
                                        class="feather icon-calendar"></i></span>
                                <input type="date" class="form-control border-0 bg-light fw-bold fs-6"
                                    [(ngModel)]="deposit.depositDate" name="depDate">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Interest Rate -->
                <div class="col-md-3">
                    <div class="card shadow-sm border-0 h-100 rounded-3">
                        <div class="card-body py-3 px-4 d-flex flex-column justify-content-center">
                            <label class="text-muted small fw-bold text-uppercase mb-2">Interest Rate (%) <span
                                    class="text-danger">*</span></label>
                            <div class="input-group shadow-sm rounded">
                                <input type="number"
                                    class="form-control border-0 bg-light fw-bold fs-5 text-center text-primary"
                                    [(ngModel)]="deposit.interestRate" name="intRate" (change)="onInterestRateChange()"
                                    min="0.1" step="0.1">
                                <span class="input-group-text bg-light border-0 fw-bold">%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HERO: PRINCIPAL LOAN AMOUNT -->
            <div class="card shadow-sm border-0 mb-4 rounded-3 overflow-hidden">
                <div class="card-body p-0">
                    <div class="row g-0">
                        <div class="col-md-12">
                            <div class="p-4" [ngClass]="isLoanAmountInvalid ? 'bg-danger-light' : 'bg-primary-light'">
                                <label class="form-label fw-bold small text-uppercase mb-2"
                                    [class.text-danger]="isLoanAmountInvalid"
                                    [class.text-primary]="!isLoanAmountInvalid">
                                    Principal Loan Amount <span class="text-danger">*</span>
                                </label>
                                <div class="input-group input-group-lg bg-white rounded shadow-sm border-0">
                                    <span class="input-group-text border-0 bg-transparent text-secondary ps-4 fs-4">{{
                                        currencySymbol }}</span>
                                    <input type="text" class="form-control border-0 fs-2 fw-bold text-dark ps-2"
                                        [class.text-danger]="isLoanAmountInvalid" [ngModel]="loanAmountDisplay"
                                        (input)="onLoanAmountInput($event)" name="loanAmt" placeholder="0">
                                </div>
                                <div class="d-flex justify-content-between align-items-center mt-2 px-1">
                                    <small class="fw-bold" [class.text-danger]="isLoanAmountInvalid"
                                        [class.text-muted]="!isLoanAmountInvalid">
                                        <i class="feather icon-info me-1"></i>
                                        <span *ngIf="isLoanAmountInvalid">Exceeds Limit by {{ currencySymbol }}{{
                                            excessAmount | number }}</span>
                                        <span *ngIf="!isLoanAmountInvalid">Max Eligible Limit: {{ currencySymbol }}{{
                                            eligibleLoanAmount | number }}</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- COLLATERAL TABLE -->
            <div class="card shadow-sm border-0 mb-4 rounded-3">
                <div class="card-header bg-white py-3 border-0 d-flex justify-content-between align-items-center">
                    <h6 class="fw-bold text-dark mb-0 text-uppercase letter-spacing-1">Collateral Items</h6>
                    <button class="btn btn-light btn-sm fw-bold border" (click)="addItemLine()">
                        <i class="feather icon-plus text-primary me-1"></i> Add Item
                    </button>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="bg-light text-uppercase">
                            <tr>
                                <th class="ps-4 py-3 small fw-bold text-muted border-0" style="width: 20%;">Item</th>
                                <th class="text-end py-3 small fw-bold text-muted border-0" style="width: 15%;">Gross Wt
                                </th>
                                <th class="text-center py-3 small fw-bold text-muted border-0" style="width: 10%;">Fine
                                    %</th>
                                <th class="text-end py-3 small fw-bold text-muted border-0" style="width: 15%;">Fine Wt
                                </th>
                                <th class="text-end py-3 small fw-bold text-primary border-0" style="width: 15%;">
                                    Valuation</th>
                                <th class="ps-4 text-start py-3 small fw-bold text-muted border-0" style="width: 20%;">
                                    Description</th>
                                <th class="py-3 border-0" style="width: 5%;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr *ngFor="let line of deposit.itemLines; let i = index">
                                <td class="ps-4">
                                    <select class="form-select form-select-sm border-0 bg-light fw-bold text-dark"
                                        [(ngModel)]="line.itemId" [name]="'item'+i" (change)="onItemChange(line)">
                                        <option [ngValue]="null" disabled selected>Select Item</option>
                                        <option *ngFor="let item of items" [value]="item.id">{{ item.itemName }}
                                        </option>
                                    </select>
                                </td>
                                <td>
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control text-end border-0"
                                            [(ngModel)]="line.weight" [name]="'wt'+i" (input)="onWeightChange(line)"
                                            (blur)="formatDecimal(line, 'weight')" placeholder="0.000">
                                        <span class="input-group-text bg-transparent border-0 text-muted small">{{
                                            getUnitName(line.itemId) }}</span>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <div class="bg-light rounded d-inline-block px-2">
                                        <input type="number"
                                            class="form-control form-control-sm border-0 bg-transparent text-center p-0 fw-bold"
                                            style="width: 50px;" [(ngModel)]="line.finePercentage" [name]="'fpt'+i"
                                            (input)="onFinePercentageChange(line)" max="100" min="0" step="1">
                                    </div>
                                </td>
                                <td>
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control text-end border-0 bg-light rounded"
                                            [(ngModel)]="line.fineWeight" [name]="'fwt'+i" tabindex="-1" readonly
                                            placeholder="0.000">
                                    </div>
                                </td>
                                <td>
                                    <div class="text-end text-primary fw-bold" style="font-family: monospace;">
                                        {{ currencySymbol }} {{ line.assetValue != null ? (line.assetValue | number) :
                                        '0' }}
                                    </div>
                                </td>
                                <td class="ps-4">
                                    <input type="text" class="form-control form-control-sm border-0 text-muted"
                                        [(ngModel)]="line.description" [name]="'desc'+i" placeholder="Add details...">
                                </td>
                                <td class="text-center">
                                    <button type="button"
                                        class="btn btn-link text-danger p-0 opacity-50 hover-opacity-100"
                                        (click)="deposit.itemLines.splice(i, 1)">
                                        <i class="feather icon-x-circle"></i>
                                    </button>
                                </td>
                            </tr>
                            <tr *ngIf="deposit.itemLines.length === 0">
                                <td colspan="7" class="text-center py-5">
                                    <div class="text-muted opacity-50">
                                        <i class="feather icon-layers display-6 mb-2"></i>
                                        <p class="mb-0 small">No items added yet. Click "Add Item" to start.</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- FINANCIAL SUMMARY & ACTIONS -->
            <div class="row" *ngIf="deposit.itemLines.length > 0">
                <div class="col-lg-6">
                    <!-- Optional: Notes or Extra Actions could go here -->
                    <div class="form-group">
                        <label class="form-label text-muted small fw-bold text-uppercase">Notes / Remarks</label>
                        <textarea class="form-control bg-light border-0" rows="4" [(ngModel)]="deposit.notes"
                            name="notes" placeholder="Enter any specific transaction notes..."></textarea>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="card shadow-sm border-0 rounded-3 bg-white">
                        <div class="card-body p-4">
                            <!-- Metal Totals -->
                            <div class="mb-4" *ngFor="let group of itemSummaryGrouped">
                                <div class="d-flex justify-content-between align-items-center p-2 bg-light rounded">
                                    <span class="fw-bold text-dark small text-uppercase me-2">{{ group.name }}</span>
                                    <div class="text-end lh-1">
                                        <span class="fw-bold text-dark">{{ group.weight | number:'1.3-3' }} {{
                                            group.unit }}</span>
                                        <br>
                                        <small class="text-muted" style="font-size: 0.75rem;">Fine: {{ group.fineWeight
                                            | number:'1.3-3' }}</small>
                                    </div>
                                </div>
                            </div>

                            <hr class="opacity-10 my-3">

                            <!-- Financials -->
                            <!-- Financials -->
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted fw-bold text-uppercase">Total Valuation</span>
                                <span class="fw-bold fs-4 text-primary">{{ currencySymbol }} {{ totalAssetValue | number
                                    }}</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                                <span class="text-muted fw-bold text-uppercase">
                                    Max Limit (<input type="number"
                                        class="border-0 text-primary fw-bold p-0 text-center bg-transparent"
                                        style="width: 50px;" [(ngModel)]="deposit.givingPercentage" name="givingPct"
                                        (change)="onGivingPercentageChange()">%)
                                </span>
                                <span class="fw-bold fs-3 text-dark">{{ currencySymbol }} {{ eligibleLoanAmount | number
                                    }}</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-3 pt-3 border-top">
                                <span class="text-success fw-bold text-uppercase fs-5">TOTAL MARGIN</span>
                                <span class="fw-bold text-success fs-4">{{ currencySymbol }} {{ netValuationSurplus |
                                    number }}</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="text-muted fw-bold text-uppercase">Est. Monthly Interest</span>
                                <span class="fw-bold fs-5 text-danger">{{ currencySymbol }} {{ monthlyInterestAmount |
                                    number:'1.0-0' }}</span>
                            </div>

                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <span class="text-muted small fw-bold text-uppercase">DURATION</span>
                                <span class="fw-bold fs-5 text-dark">
                                    {{ interestCoverMonths | number:'1.1-1' }} <small class="text-muted">Months</small>
                                </span>
                            </div>

                            <!-- Submit Button -->
                            <div class="d-grid gap-2 mt-4">
                                <button class="btn btn-primary btn-lg shadow-lg fw-bold" (click)="submitDeposit()"
                                    [disabled]="isLoanAmountInvalid || !deposit.customerId || deposit.itemLines.length === 0 || !deposit.tokenNo || !deposit.depositDate || !deposit.interestRate">
                                    <i class="feather icon-check-circle me-2"></i>
                                    {{ isEditMode ? 'UPDATE DEPOSIT RECORD' : 'SUBMIT DEPOSIT RECORD' }}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<!-- NEW CUSTOMER MODAL (Maintained as is) -->
<div class="modal fade show" *ngIf="showNewCustomerModal" style="display: block; background: rgba(0,0,0,0.5);"
    tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content shadow-lg border-0">
            <div class="modal-header bg-primary text-white py-3">
                <h6 class="modal-title fw-bold text-white mb-0">
                    <i class="feather icon-user-plus me-2"></i> Add New Customer
                </h6>
                <button type="button" class="btn-close btn-close-white" (click)="showNewCustomerModal = false"></button>
            </div>
            <div class="modal-body p-4 bg-light">
                <div class="card border-0 shadow-sm p-3">
                    <div class="row g-3">
                        <div class="col-md-12">
                            <label class="form-label small fw-bold">Full Name *</label>
                            <input type="text" class="form-control" [(ngModel)]="newCustomer.customerName"
                                name="newCName" placeholder="Enter full name">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Mobile Number *</label>
                            <input type="text" class="form-control" [(ngModel)]="newCustomer.mobileNumber"
                                name="newCMobile" placeholder="10-digit mobile">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold">Email</label>
                            <input type="email" class="form-control" [(ngModel)]="newCustomer.email" name="newCEmail"
                                placeholder="Optional">
                        </div>
                        <div class="col-md-12">
                            <label class="form-label small fw-bold">Address</label>
                            <textarea class="form-control" rows="2" [(ngModel)]="newCustomer.address" name="newCAddress"
                                placeholder="Street address"></textarea>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">City/Village</label>
                            <input type="text" class="form-control" [(ngModel)]="newCustomer.village"
                                name="newCVillage">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">District</label>
                            <input type="text" class="form-control" [(ngModel)]="newCustomer.district"
                                name="newCDistrict">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label small fw-bold">State</label>
                            <input type="text" class="form-control" [(ngModel)]="newCustomer.state" name="newCState">
                        </div>
                        <div class="col-md-6 form-group position-relative">
                            <label class="form-label small fw-bold">Referral Name</label>
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Search Referral..."
                                    [(ngModel)]="referralSearchTerm" name="refSearch" (input)="searchReferrals()">
                            </div>

                            <!-- Referral Search Dropdown -->
                            <div class="list-group position-absolute w-100 shadow-lg" *ngIf="showReferralResults"
                                style="z-index: 1000; max-height: 200px; overflow-y: auto;">
                                <button type="button" class="list-group-item list-group-item-action"
                                    *ngFor="let result of referralSearchResults" (click)="selectReferral(result)">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">{{ result.customerName }}</h6>
                                        <small>ID: {{ result.id }}</small>
                                    </div>
                                    <small class="text-muted">{{ result.city }}</small>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 d-flex align-items-center pt-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" [(ngModel)]="newCustomer.kycVerified"
                                    id="kycCheck" name="newCKyc">
                                <label class="form-check-label fw-bold small" for="kycCheck">
                                    KYC Verified
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 bg-white">
                <button type="button" class="btn btn-light text-muted"
                    (click)="showNewCustomerModal = false">Cancel</button>
                <button type="button" class="btn btn-primary px-4" (click)="saveNewCustomer()">Save Customer</button>
            </div>
        </div>
    </div>
</div>