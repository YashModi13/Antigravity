<div class="row">

    <!-- LIST VIEW: Business Standard Layout -->
    <div class="col-12 fade-in-up" *ngIf="!portfolio">

        <!-- 1. Page Header (Title & Stats) -->
        <div class="d-flex justify-content-between align-items-end mb-4 px-2 pt-4">
            <div>
                <h4 class="fw-bold text-dark mb-1">Customer Registry</h4>
                <p class="text-muted mb-0 small">
                    Manage your customer portfolio effectively.
                </p>
            </div>
            <div class="text-end">
                <span class="badge bg-light text-dark border px-3 py-2 rounded-pill fw-normal">
                    <span class="fw-bold">{{ filteredCustomers.length }}</span> / {{ customersList.length }} Customers
                </span>
            </div>
        </div>

        <!-- 2. Unified Command Toolbar (Search + Filters + Actions) -->
        <div class="card border-0 shadow-sm rounded-4 mb-4" style="z-index: 10;">
            <div class="card-body p-2 ps-3">
                <div class="row align-items-center g-2">

                    <!-- Search Bar Section -->
                    <div class="col-lg-5 position-relative">
                        <div class="input-group">
                            <span class="input-group-text bg-transparent border-0 ps-1 pe-2">
                                <i class="feather icon-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control border-0 bg-transparent fw-medium"
                                placeholder="Search by Name, Mobile..." [(ngModel)]="searchTerm"
                                (keyup)="searchCustomers()" style="box-shadow: none;">

                            <span class="input-group-text bg-transparent border-0" *ngIf="searchTerm"
                                (click)="searchTerm=''; searchCustomers()" style="cursor: pointer;">
                                <i class="feather icon-x-circle text-secondary"></i>
                            </span>
                        </div>

                        <!-- Dropdown Results (Absolute) -->
                        <div *ngIf="showResults"
                            class="card position-absolute w-100 mt-2 shadow-lg border-0 rounded-4 overflow-hidden text-start"
                            style="top: 100%; left: 0; z-index: 1050;">
                            <ul class="list-group list-group-flush">
                                <li *ngFor="let customer of searchResults"
                                    class="list-group-item list-group-item-action p-2 px-3 d-flex align-items-center justify-content-between"
                                    style="cursor: pointer;" (click)="selectCustomer(customer)">
                                    <div class="d-flex align-items-center">
                                        <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center me-2"
                                            style="width: 35px; height: 35px; font-size: 0.9rem; font-weight: bold;">
                                            {{ customer.customerName.charAt(0) }}
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark small">{{ customer.customerName }}</div>
                                            <div class="text-xs text-muted">
                                                <span class="me-2"><i class="feather icon-phone me-1"></i>{{
                                                    customer.mobileNumber }}</span>
                                                <span *ngIf="customer.village || customer.district"
                                                    class="text-secondary opacity-75">
                                                    | <i class="feather icon-map-pin me-1 ms-1"></i>{{ customer.village
                                                    }}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <i class="feather icon-arrow-right-circle text-muted opacity-25"></i>
                                </li>
                                <li *ngIf="searchResults.length === 0"
                                    class="list-group-item p-3 text-center text-muted small">
                                    No matching customers found.
                                </li>
                            </ul>
                        </div>
                    </div>

                    <!-- Divider -->
                    <div class="col-auto d-none d-lg-block">
                        <div class="vr h-100 text-muted opacity-25" style="min-height: 24px;"></div>
                    </div>

                    <!-- Filters Section -->
                    <div class="col-lg-auto d-flex gap-2 flex-grow-1">
                        <!-- Village -->
                        <select
                            class="form-select border-0 bg-light rounded-pill px-3 py-2 small fw-medium text-secondary"
                            style="font-size: 0.85rem; min-width: 140px; cursor: pointer;" [(ngModel)]="selectedVillage"
                            (change)="applyFilters()">
                            <option value="">All Villages</option>
                            <option *ngFor="let v of villages" [value]="v">{{ v }}</option>
                        </select>

                        <!-- District -->
                        <select
                            class="form-select border-0 bg-light rounded-pill px-3 py-2 small fw-medium text-secondary"
                            style="font-size: 0.85rem; min-width: 140px; cursor: pointer;"
                            [(ngModel)]="selectedDistrict" (change)="applyFilters()">
                            <option value="">All Districts</option>
                            <option *ngFor="let d of districts" [value]="d">{{ d }}</option>
                        </select>

                        <!-- Clear Link -->
                        <button *ngIf="selectedVillage || selectedDistrict"
                            class="btn btn-sm btn-link text-danger text-decoration-none fw-bold"
                            (click)="clearFilters()">
                            Clear
                        </button>
                    </div>

                    <!-- Actions Section -->
                    <div class="col-auto ms-auto">
                        <button
                            class="btn btn-light border rounded-circle d-flex align-items-center justify-content-center bg-white shadow-sm"
                            style="width: 40px; height: 40px;" (click)="loadCustomers()" title="Reload Registry">
                            <i class="feather icon-rotate-cw text-primary"></i>
                        </button>
                    </div>

                </div>
            </div>
        </div> <!-- Main Customer Table Card -->
        <!-- Main Customer Table Card -->
        <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light text-uppercase small text-muted fw-bold border-bottom">
                            <tr>
                                <th class="ps-4 py-3 border-0" style="width: 5%; cursor: pointer;"
                                    (click)="onSort('id')">
                                    ID <i class="feather"
                                        [ngClass]="{'icon-chevron-up': sortBy === 'id' && sortDir === 'asc', 'icon-chevron-down': sortBy === 'id' && sortDir === 'desc'}"></i>
                                </th>
                                <th class="border-0" style="width: 20%; cursor: pointer;"
                                    (click)="onSort('customerName')">
                                    Customer <i class="feather"
                                        [ngClass]="{'icon-chevron-up': sortBy === 'customerName' && sortDir === 'asc', 'icon-chevron-down': sortBy === 'customerName' && sortDir === 'desc'}"></i>
                                </th>
                                <th class="border-0" style="width: 12%; cursor: pointer;"
                                    (click)="onSort('mobileNumber')">
                                    Contact <i class="feather"
                                        [ngClass]="{'icon-chevron-up': sortBy === 'mobileNumber' && sortDir === 'asc', 'icon-chevron-down': sortBy === 'mobileNumber' && sortDir === 'desc'}"></i>
                                </th>
                                <th class="border-0" style="width: 15%;">Address</th>
                                <th class="border-0" style="width: 18%;">
                                    Location
                                </th>
                                <th class="border-0" style="width: 12%; cursor: pointer;"
                                    (click)="onSort('referralName')">
                                    Referral <i class="feather"
                                        [ngClass]="{'icon-chevron-up': sortBy === 'referralName' && sortDir === 'asc', 'icon-chevron-down': sortBy === 'referralName' && sortDir === 'desc'}"></i>
                                </th>
                                <th class="border-0 text-center" style="width: 5%; cursor: pointer;"
                                    (click)="onSort('kycVerified')">
                                    KYC
                                </th>
                                <th class="text-end pe-4 border-0" style="width: 13%;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Item Row -->
                            <tr *ngFor="let c of filteredCustomers" class="position-relative">
                                <td class="ps-4 fw-medium text-secondary">#{{ c.id }}</td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-initials bg-primary bg-opacity-10 text-primary rounded-circle me-3 d-flex align-items-center justify-content-center fw-bold"
                                            style="width: 40px; height: 40px; font-size: 1rem;">
                                            {{ c.customerName.charAt(0) }}
                                        </div>
                                        <div>
                                            <div class="fw-bold text-dark fs-6">{{ c.customerName }}</div>
                                            <div class="small text-muted" *ngIf="c.email"><i
                                                    class="feather icon-mail me-1"></i>{{ c.email }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center text-dark">
                                        <i class="feather icon-phone text-muted me-2 small"></i>
                                        <span class="fw-medium">{{ c.mobileNumber }}</span>
                                    </div>
                                </td>
                                <td>
                                    <div class="small text-secondary text-wrap" style="max-width: 150px;">{{ c.address
                                        || '-' }}</div>
                                </td>
                                <td>
                                    <div class="fw-medium text-dark small">{{ c.village || '-' }}</div>
                                    <div class="text-xs text-muted">
                                        {{ c.district || '-' }}<span *ngIf="c.state">, {{ c.state }}</span>
                                        <span *ngIf="c.pincode"> - {{ c.pincode }}</span>
                                    </div>
                                </td>
                                <td>
                                    <span *ngIf="c.referralCustomer"
                                        class="badge bg-primary bg-opacity-10 text-primary border border-primary border-opacity-10 clickable-badge"
                                        style="cursor: pointer;" (click)="selectCustomer(c.referralCustomer)">
                                        <i class="feather icon-user-check me-1"></i>{{ c.referralName }}
                                    </span>
                                    <span *ngIf="!c.referralName" class="text-muted small">-</span>
                                </td>
                                <td class="text-center">
                                    <i *ngIf="c.kycVerified" class="feather icon-check-circle text-success fs-5"
                                        title="Verified"></i>
                                    <i *ngIf="!c.kycVerified"
                                        class="feather icon-alert-circle text-muted fs-5 opacity-50"
                                        title="Pending"></i>
                                </td>
                                <td class="text-end pe-4">
                                    <button class="btn btn-sm btn-outline-secondary me-1 rounded-pill px-3 fw-medium"
                                        (click)="editCustomer(c)">
                                        Edit
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary rounded-pill px-3 fw-medium"
                                        (click)="selectCustomer(c)">
                                        View
                                    </button>
                                </td>
                            </tr>

                            <!-- Empty State -->
                            <tr *ngIf="filteredCustomers.length === 0">
                                <td colspan="8" class="text-center py-5">
                                    <div class="py-4">
                                        <div class="bg-light rounded-circle d-inline-flex p-3 mb-3">
                                            <i class="feather icon-users text-muted opacity-50 fs-2"></i>
                                        </div>
                                        <h6 class="text-dark fw-bold">No Customers Found</h6>
                                        <p class="text-muted small mb-0">Try adjusting your filters or search terms.</p>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Footer -->
                <div class="d-flex justify-content-between align-items-center px-4 py-3 bg-light border-top"
                    *ngIf="totalElements > 0">
                    <span class="text-muted small fw-medium">
                        Showing {{ page * size + 1 }} to {{ Math.min((page + 1) * size, totalElements) }} of {{
                        totalElements }} entries
                    </span>
                    <nav aria-label="Page navigation">
                        <ul class="pagination pagination-sm mb-0 gap-1">
                            <li class="page-item" [class.disabled]="page === 0">
                                <button class="page-link border bg-white rounded-start-pill text-secondary"
                                    (click)="onPageChange(page - 1)" [disabled]="page === 0">
                                    <i class="feather icon-chevron-left me-1"></i> Prev
                                </button>
                            </li>
                            <li class="page-item disabled">
                                <span class="page-link border bg-white text-dark fw-bold px-3">Page {{ page + 1 }} of {{
                                    totalPages }}</span>
                            </li>
                            <li class="page-item" [class.disabled]="page === totalPages - 1">
                                <button class="page-link border bg-white rounded-end-pill text-secondary"
                                    (click)="onPageChange(page + 1)" [disabled]="page === totalPages - 1">
                                    Next <i class="feather icon-chevron-right ms-1"></i>
                                </button>
                            </li>
                        </ul>
                    </nav>
                </div>

            </div>
        </div>

    </div>

    <!-- MAIN PORTFOLIO VIEW -->
    <div class="col-12 fade-in-up" *ngIf="portfolio">

        <!-- Top Navigation & Search -->
        <div class="mb-4 d-flex gap-3 align-items-center">
            <!-- Back Button -->
            <button
                class="btn btn-white border shadow-sm rounded-circle d-flex align-items-center justify-content-center"
                style="width: 45px; height: 45px;" (click)="portfolio = null; searchTerm = ''" title="Back to List">
                <i class="feather icon-arrow-left text-dark fs-5"></i>
            </button>

            <!-- Search Bar -->
            <div class="position-relative flex-grow-1">
                <input type="text" class="form-control border-0 shadow-sm ps-4 rounded-pill"
                    placeholder="Search another customer..." [(ngModel)]="searchTerm" (keyup)="searchCustomers()">
                <i class="feather icon-search position-absolute top-50 end-0 translate-middle-y me-3 text-muted"></i>

                <div *ngIf="showResults"
                    class="card position-absolute w-100 mt-1 shadow border-0 rounded-3 overflow-hidden"
                    style="z-index: 1000;">
                    <ul class="list-group list-group-flush">
                        <li *ngFor="let customer of searchResults"
                            class="list-group-item list-group-item-action p-2 smaller" style="cursor: pointer;"
                            (click)="selectCustomer(customer)">
                            <div class="fw-bold">{{ customer.customerName }}</div>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- Clear/Action Button (Optional, maybe specific actions later) -->
            <!-- <button class="btn btn-dark rounded-pill px-4 shadow-sm" (click)="portfolio = null; searchTerm = ''">
                <i class="feather icon-x me-2"></i> Close
            </button> -->
        </div>

        <!-- Customer Profile & Dashboard Card -->
        <div class="card border-0 shadow-sm bg-white overflow-hidden mb-4">
            <div class="card-body p-4 position-relative">
                <div class="row align-items-center">
                    <div class="col-md-6 d-flex align-items-center gap-3">
                        <div class="bg-primary bg-opacity-10 text-primary rounded-circle d-flex align-items-center justify-content-center"
                            style="width: 60px; height: 60px;">
                            <span class="fs-4 fw-bold">{{ portfolio.customerName.charAt(0)
                                }}</span>
                        </div>
                        <div>
                            <h4 class="fw-bold mb-1 text-dark">{{ portfolio.customerName }}</h4>
                            <div class="text-muted d-flex gap-3 small">
                                <span><i class="feather icon-phone me-1"></i> {{
                                    portfolio.mobileNumber }}</span>
                                <span><i class="feather icon-map-pin me-1"></i> {{
                                    portfolio.city || 'Local' }}</span>
                            </div>
                        </div>
                    </div>
                    <!-- Stats -->
                    <div class="col-md-6 d-flex gap-3 justify-content-end mt-3 mt-md-0">
                        <div class="px-3 py-2 bg-light rounded-3 text-end border-start border-4 border-primary">
                            <div class="text-uppercase text-muted fw-bold" style="font-size: 0.65rem;">Active Loan</div>
                            <div class="fs-5 fw-bold text-dark">{{ totalLoan | currency:'INR' }}
                            </div>
                        </div>
                        <div class="px-3 py-2 bg-light rounded-3 text-end border-start border-4 border-success">
                            <div class="text-uppercase text-muted fw-bold" style="font-size: 0.65rem;">Asset Value</div>
                            <div class="fs-5 fw-bold text-success">{{ totalAssetValue |
                                currency:'INR' }}</div>
                        </div>
                        <div class="px-3 py-2 bg-light rounded-3 text-end border-start border-4 border-info">
                            <div class="text-uppercase text-muted fw-bold" style="font-size: 0.65rem;">NET EQUITY</div>
                            <div class="fs-5 fw-bold text-info">{{ (totalAssetValue - totalLoan)
                                | currency:'INR' }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TABS -->
        <div class="mb-3">
            <ul class="nav nav-pills nav-fill bg-white shadow-sm rounded-3 p-1">
                <li class="nav-item">
                    <a class="nav-link fw-bold" [class.active]="activeTab === 'ACTIVE'"
                        [class.text-dark]="activeTab !== 'ACTIVE'" style="cursor: pointer;"
                        (click)="activeTab = 'ACTIVE'">
                        <i class="feather icon-layers me-2"></i> Active Pledges
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link fw-bold" [class.active]="activeTab === 'HISTORY'"
                        [class.text-dark]="activeTab !== 'HISTORY'" style="cursor: pointer;"
                        (click)="activeTab = 'HISTORY'">
                        <i class="feather icon-clock me-2"></i> History & Closed
                    </a>
                </li>
            </ul>
        </div>

        <!-- DEPOSITS LIST -->
        <ng-container *ngFor="let deposit of portfolio.deposits">
            <!-- Filter Logic -->
            <ng-container
                *ngIf="(activeTab === 'ACTIVE' && deposit.status !== 'CLOSED') || (activeTab === 'HISTORY' && deposit.status === 'CLOSED')">
                <div class="card border-0 shadow-sm mb-3 deposit-card" [ngClass]="deposit.status">
                    <div class="card-body p-0">

                        <!-- Header -->
                        <div
                            class="p-3 d-flex flex-wrap justify-content-between align-items-center border-bottom bg-opacity-10 bg-light">
                            <div class="d-flex align-items-center gap-3">
                                <h5 class="mb-0 fw-bold text-primary">Bill #{{ deposit.depositId
                                    }}</h5>
                                <span class="badge rounded-pill px-3" [ngClass]="{
                                    'bg-success': deposit.status === 'ACTIVE',
                                    'bg-secondary': deposit.status === 'CLOSED',
                                    'bg-danger': deposit.status === 'RISK'
                                }">{{ deposit.status }}</span>

                                <span class="text-muted small ms-2">
                                    <i class="feather icon-calendar me-1"></i>
                                    <span *ngIf="deposit.status !== 'CLOSED'">{{
                                        deposit.depositDate | date:'mediumDate'
                                        }}</span>
                                    <span *ngIf="deposit.status === 'CLOSED'">{{
                                        deposit.depositDate | date:'mediumDate'
                                        }} - {{ deposit.endDate | date:'mediumDate' }}</span>
                                </span>
                            </div>

                            <!-- Financials -->
                            <div class="d-flex gap-4 text-end small fw-medium mt-2 mt-md-0">
                                <div>
                                    <div class="text-muted text-uppercase" style="font-size: 0.65rem;">Duration</div>
                                    <div class="text-dark">{{ deposit.durationDisplay }}</div>
                                </div>
                                <div>
                                    <div class="text-muted text-uppercase" style="font-size: 0.65rem;">Rate</div>
                                    <div class="text-dark">{{ deposit.interestRate }}%</div>
                                </div>
                                <div>
                                    <div class="text-muted text-uppercase" style="font-size: 0.65rem;"
                                        *ngIf="deposit.status !== 'CLOSED'">Interest (Est)</div>
                                    <div class="text-muted text-uppercase" style="font-size: 0.65rem;"
                                        *ngIf="deposit.status === 'CLOSED'">Interest Paid</div>
                                    <div class="fw-bold" [class.text-warning]="deposit.status !== 'CLOSED'"
                                        [class.text-success]="deposit.status === 'CLOSED'">
                                        {{ (deposit.status === 'CLOSED' ? deposit.paidInterest :
                                        deposit.accruedInterest) | currency:'INR' }}
                                    </div>
                                </div>
                                <div>
                                    <div class="text-muted text-uppercase" style="font-size: 0.65rem;">Loan Amount</div>
                                    <div class="fw-bold text-danger fs-6">{{ (deposit.status ===
                                        'CLOSED' ?
                                        deposit.initialLoanAmount : deposit.loanAmount) |
                                        currency:'INR' }}</div>
                                </div>
                                <div *ngIf="deposit.status === 'CLOSED'">
                                    <div class="text-muted text-uppercase" style="font-size: 0.65rem;">Total Paid</div>
                                    <div class="fw-bold text-success fs-6">{{
                                        (deposit.paidPrincipal +
                                        deposit.paidInterest) | currency:'INR' }}</div>
                                </div>
                            </div>
                        </div>

                        <!-- Items Table -->
                        <div class="p-3">
                            <div class="table-responsive">
                                <table class="table table-borderless table-sm align-middle mb-0">
                                    <thead class="text-secondary text-uppercase small"
                                        style="border-bottom: 1px dashed #eee;">
                                        <tr>
                                            <th class="ps-0">Item Details</th>
                                            <th>Weight</th>
                                            <th>Fine Wt</th>
                                            <th class="text-end">Status</th>
                                            <th class="text-end pe-0">Asset Value</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr *ngFor="let item of deposit.items">
                                            <td class="ps-0 fw-bold text-dark">{{ item.itemName
                                                }}</td>
                                            <td>{{ item.weight }}g</td>
                                            <td>{{ item.fineWeight }}g</td>
                                            <td class="text-end">
                                                <span class="badge bg-light text-dark border small">{{
                                                    item.status
                                                    }}</span>
                                            </td>
                                            <td class="text-end fw-bold text-success pe-0">{{
                                                item.currentAssetValue |
                                                currency:'INR' }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>

                            <!-- Footer Stats & Drift Toggle -->
                            <div class="border-top pt-2 mt-2 pb-2 d-flex justify-content-between align-items-center bg-light rounded-bottom px-3"
                                *ngIf="deposit.status !== 'CLOSED'">
                                <div class="d-flex align-items-center gap-3">


                                    <!-- QUICK ACTIONS (MOVED HERE) -->
                                    <app-deposit-detail-view [deposit]="deposit" [customerName]="portfolio.customerName"
                                        (refresh)="loadPortfolio(portfolio.customerId)">
                                    </app-deposit-detail-view>
                                </div>

                                <div class="d-flex gap-4 text-muted small">
                                    <span>Total Paid: <span class="text-dark fw-bold">{{
                                            (deposit.paidPrincipal +
                                            deposit.paidInterest) | currency:'INR'
                                            }}</span></span>
                                    <span>Pending Interest: <span class="text-danger fw-bold">{{
                                            (deposit.accruedInterest - deposit.paidInterest) |
                                            currency:'INR'
                                            }}</span></span>
                                    <span>Total Unpaid: <span class="text-danger fw-bold">{{
                                            (deposit.loanAmount +
                                            (deposit.accruedInterest - deposit.paidInterest)) |
                                            currency:'INR'
                                            }}</span></span>
                                </div>
                            </div>
                            <!-- CLOSED Footer just for Drift Toggle -->
                            <div class="border-top pt-2 mt-2 pb-2 bg-light rounded-bottom d-flex justify-content-between align-items-center px-3"
                                *ngIf="deposit.status === 'CLOSED'">


                                <!-- Net Profit Display -->
                                <div>
                                    <span class="text-uppercase small fw-bold me-2"
                                        [ngClass]="deposit.netProfitLoss >= 0 ? 'text-success' : 'text-danger'">
                                        {{ deposit.netProfitLoss >= 0 ? 'Net Profit' : 'Net
                                        Loss' }}:
                                    </span>
                                    <span class="fw-bold fs-6"
                                        [ngClass]="deposit.netProfitLoss >= 0 ? 'text-success' : 'text-danger'">
                                        {{ deposit.netProfitLoss | currency:'INR' }}
                                    </span>
                                </div>
                            </div>



                        </div>
                    </div>
                </div>
            </ng-container>
        </ng-container>

        <!-- Empty State for Tab -->
        <div class="text-center py-5"
            *ngIf="portfolio.deposits?.length > 0 && ((activeTab === 'ACTIVE' && portfolio.activeDeposits === 0) || (activeTab === 'HISTORY' && portfolio.deposits.length === portfolio.activeDeposits))">
            <i class="feather icon-folder-minus fs-1 text-muted opacity-25"></i>
            <p class="mt-3 text-muted">No records found for this view.</p>
        </div>

    </div>
</div>

<!-- Edit Customer Modal -->
<div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'" tabindex="-1"
    role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header border-bottom bg-white rounded-top-4 p-4">
                <h5 class="modal-title fw-bold text-dark"><i class="feather icon-edit me-2 text-primary"></i>Edit
                    Customer Details</h5>
                <button type="button" class="btn-close" (click)="closeEditModal()"></button>
            </div>
            <div class="modal-body p-4 bg-light bg-opacity-10">
                <form #editForm="ngForm">
                    <div class="row g-3">
                        <!-- Basic Info -->
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted text-uppercase">Customer Name <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-lg rounded-3 border-0 shadow-sm"
                                [(ngModel)]="editingCustomer.customerName" name="editName" required
                                placeholder="Enter full name">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted text-uppercase">Mobile Number <span
                                    class="text-danger">*</span></label>
                            <input type="text" class="form-control form-control-lg rounded-3 border-0 shadow-sm"
                                [(ngModel)]="editingCustomer.mobileNumber" name="editMobile" required
                                placeholder="10-digit mobile number">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted text-uppercase">Email Address</label>
                            <input type="email" class="form-control form-control-lg rounded-3 border-0 shadow-sm"
                                [(ngModel)]="editingCustomer.email" name="editEmail" placeholder="Optional">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted text-uppercase">KYC Status</label>
                            <div class="d-flex align-items-center mt-2">
                                <div class="form-check form-switch custom-switch-lg">
                                    <input class="form-check-input" type="checkbox" id="editKycVerified"
                                        [(ngModel)]="editingCustomer.kycVerified" name="editKycVerified">
                                    <label class="form-check-label fw-bold text-dark ms-2" for="editKycVerified">
                                        {{ editingCustomer.kycVerified ? 'Verified' : 'Pending Verification' }}
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Address Section -->
                        <div class="col-12 mt-4">
                            <h6 class="text-primary fw-bold small text-uppercase mb-3 border-bottom pb-2">Address &
                                Location</h6>
                        </div>
                        <div class="col-md-12">
                            <label class="form-label small fw-bold text-muted text-uppercase">Full Address</label>
                            <textarea class="form-control rounded-3 border-0 shadow-sm" rows="2"
                                [(ngModel)]="editingCustomer.address" name="editAddress"
                                placeholder="Street, landmark, etc."></textarea>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted text-uppercase">Village/City</label>
                            <input type="text" class="form-control rounded-3 border-0 shadow-sm"
                                [(ngModel)]="editingCustomer.village" name="editVillage">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted text-uppercase">District</label>
                            <input type="text" class="form-control rounded-3 border-0 shadow-sm"
                                [(ngModel)]="editingCustomer.district" name="editDistrict">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted text-uppercase">State</label>
                            <input type="text" class="form-control rounded-3 border-0 shadow-sm"
                                [(ngModel)]="editingCustomer.state" name="editState">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label small fw-bold text-muted text-uppercase">Pincode</label>
                            <input type="text" class="form-control rounded-3 border-0 shadow-sm"
                                [(ngModel)]="editingCustomer.pincode" name="editPincode">
                        </div>

                        <!-- Referral Section -->
                        <div class="col-12 mt-4">
                            <h6 class="text-primary fw-bold small text-uppercase mb-3 border-bottom pb-2">Referral</h6>
                        </div>
                        <div class="col-12">
                            <label class="form-label small fw-bold text-muted text-uppercase">Referred By</label>
                            <div class="position-relative">
                                <div class="input-group shadow-sm rounded-3 overflow-hidden">
                                    <span class="input-group-text bg-white border-0 ps-3"><i
                                            class="feather icon-search text-muted"></i></span>
                                    <input type="text" class="form-control border-0 py-2"
                                        [(ngModel)]="editReferralSearchTerm" name="editReferralSearch"
                                        (keyup)="searchEditReferrals()" placeholder="Search existing customer..."
                                        autocomplete="off">
                                    <button class="btn btn-light border-0 text-muted" *ngIf="editReferralSearchTerm"
                                        (click)="editReferralSearchTerm=''; editingCustomer.referralCustomer=null">
                                        <i class="feather icon-x"></i>
                                    </button>
                                </div>
                                <!-- Dropdown -->
                                <div *ngIf="showEditReferralResults"
                                    class="card position-absolute w-100 mt-1 shadow border-0 rounded-3 overflow-hidden"
                                    style="z-index: 1055; max-height: 200px; overflow-y: auto;">
                                    <ul class="list-group list-group-flush">
                                        <li *ngFor="let ref of editReferralSearchResults"
                                            class="list-group-item list-group-item-action p-2 small cursor-pointer"
                                            (click)="selectEditReferral(ref)">
                                            <div class="fw-bold text-dark">{{ ref.customerName }}</div>
                                            <div class="text-muted text-xs">{{ ref.mobileNumber }} | {{ ref.village }}
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <div class="form-text small mt-1" *ngIf="editingCustomer.referralCustomer">
                                <span class="text-success fw-bold"><i class="feather icon-check-circle me-1"></i>Linked
                                    to ID #{{ editingCustomer.referralCustomer.id }}</span>
                            </div>
                        </div>

                    </div>
                </form>
            </div>
            <div class="modal-footer border-top p-3 bg-white rounded-bottom-4">
                <button type="button" class="btn btn-light rounded-pill px-4 fw-medium text-secondary"
                    (click)="closeEditModal()">Cancel</button>
                <button type="button" class="btn btn-primary rounded-pill px-5 fw-bold shadow-sm"
                    (click)="saveEditedCustomer()" [disabled]="isLoading">
                    <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2"></span>
                    Save Changes
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal-backdrop fade show" *ngIf="showEditModal"></div>